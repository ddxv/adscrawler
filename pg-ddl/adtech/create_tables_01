
CREATE SCHEMA adtech;



CREATE TABLE adtech.categories (
    id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR NOT NULL
);


CREATE TABLE adtech.companies (
	id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"name" varchar NOT NULL,
	parent_company_id int4 NULL,
	description text NULL,
	domain_id int4 NOT NULL,
	CONSTRAINT companies_pkey PRIMARY KEY (id),
	CONSTRAINT unique_company_name UNIQUE (name),
	CONSTRAINT fk_ad_domain_id FOREIGN KEY (domain_id) REFERENCES public.ad_domains(id),
	CONSTRAINT fk_companies_parent FOREIGN KEY (parent_company_id) REFERENCES adtech.companies(id)
);


CREATE TABLE adtech.company_categories (
    company_id INT NOT NULL,
    category_id INT NOT NULL,
    PRIMARY KEY (company_id, category_id),
    CONSTRAINT fk_company_categories_company
        FOREIGN KEY (company_id) 
        REFERENCES adtech.companies (id),
    CONSTRAINT fk_company_categories_category
        FOREIGN KEY (category_id) 
        REFERENCES adtech.categories (id)
);

CREATE TABLE adtech.sdk_packages (
    id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    company_id INT NOT NULL,
    package_pattern VARCHAR NOT NULL,
    CONSTRAINT fk_sdk_packages_brand
        FOREIGN KEY(company_id)
        REFERENCES adtech.companies(id),
    CONSTRAINT unique_package_pattern UNIQUE (package_pattern)
);

CREATE INDEX ON adtech.sdk_packages (package_pattern);


CREATE TABLE adtech.company_developers (
    company_id int4 NOT NULL,
    developer_id int4 NOT NULL,
    CONSTRAINT company_developers_pkey PRIMARY KEY (company_id, developer_id),
    CONSTRAINT fk_company_developers_category FOREIGN KEY (developer_id) REFERENCES public.developers(id)
);

CREATE TABLE adtech.sdk_paths (
    id int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE),
    company_id int4 NOT NULL,
    path_pattern varchar NOT NULL,
    CONSTRAINT sdk_pathss_pkey PRIMARY KEY (id),
    CONSTRAINT unique_path_pattern UNIQUE (path_pattern)
);
CREATE INDEX sdk_path_pattern_idx ON adtech.sdk_paths USING btree (path_pattern);


-- adtech.click_url_redirect_chains definition

-- Drop table

-- DROP TABLE adtech.click_url_redirect_chains;

CREATE TABLE adtech.click_url_redirect_chains (
	id serial4 NOT NULL,
	run_id int4 NOT NULL,
	url text NOT NULL,
	redirect_url text NOT NULL,
	CONSTRAINT click_url_redirect_chains_pkey PRIMARY KEY (id),
	CONSTRAINT click_url_redirect_chains_unique UNIQUE (run_id, url, redirect_url),
	CONSTRAINT fk_run_id FOREIGN KEY (run_id) REFERENCES public.version_code_api_scan_results(id) ON DELETE CASCADE
);


